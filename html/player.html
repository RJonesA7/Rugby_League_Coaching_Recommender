<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Rugby League Recommender System - Player Level</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='webapp_styling.css') }}">
</head>
<body>
  <div class="page">
    <header class="header">
      <div class="brand">
        <div class="badge"></div>
        <div>
          <h1>Rugby League Recommender System</h1>
          <p class="subtitle">Player level opposition profile (z-scores: -3 to +3)</p>
        </div>
      </div>
    </header>

    <main class="card">
      <form method="post" action="{{ url_for('player_post') }}">

        <div class="position-grid">
          {% for pos in position_order %}
          <section class="pos-block">
            <div class="pos-head">
              <h2 class="pos-title">{{ pos }}</h2>
              <p class="pos-subtitle">Opposition {{ pos }} group</p>
            </div>

            <div class="grid">
              {% for stat in position_stats[pos] %}
              {% set field = pos ~ "__" ~ stat %}
              <div class="field">
                <label for="{{ field }}">
                  <span class="stat-name">{{ stat }}</span>
                  <span class="stat-value" id="{{ field }}_val">{{ values[pos][stat] }}</span>
                </label>

                <input
                  type="range"
                  id="{{ field }}"
                  name="{{ field }}"
                  min="-3"
                  max="3"
                  step="0.1"
                  value="{{ values[pos][stat] }}"
                  oninput="document.getElementById('{{ field }}_val').textContent = this.value"
                />
                <div class="ticks">
                  <span>-3</span><span>0</span><span>+3</span>
                </div>
              </div>
              {% endfor %}
            </div>
          </section>
          {% endfor %}
        </div>

        <div class="actions">
          <button class="btn" type="submit">Run</button>
          <a class="btn ghost" href="{{ url_for('player') }}">Reset</a>
          <a class="btn ghost" href="{{ url_for('index') }}">Back to home</a>
        </div>
      </form>

      {% if output is not none %}
      <section class="output">
        <h2>Opposition profile (z-scores)</h2>

        {% for pos in position_order %}
          <div class="pos-output">
            <h3 class="pos-out-title">{{ pos }}</h3>

            <!-- NEW: Boxplot for this position -->
            <section class="boxplot-card">
              <div class="boxplot-header">
                <h3>SHAP contribution distribution (top predicted wins)</h3>
                <div class="boxplot-controls">
                  <label class="toggle">
                    <input type="checkbox" class="bp_show_all" data-pos="{{ pos }}">
                    <span>Show all</span>
                  </label>
                  <label class="toggle">
                    <input type="checkbox" class="bp_show_zero" data-pos="{{ pos }}" checked>
                    <span>Zero line</span>
                  </label>
                </div>
              </div>

              <div class="boxplot-legend">
                <span class="legend-item"><span class="legend-box"></span> IQR (Q1–Q3)</span>
                <span class="legend-item"><span class="legend-whisker"></span> Min–Max</span>
                <span class="legend-item"><span class="legend-mean"></span> Mean</span>
              </div>

              <div id="boxplot_container__{{ pos|replace(' ', '_') }}" class="boxplot-container"></div>

              <p class="boxplot-note">
                Scale is shared across groups (computed from the data shown). Mean marker corresponds to the value in the list below.
              </p>
            </section>

            <!-- Existing numeric output -->
            <div class="stat-list">
              {% for stat, value in output[pos].items() %}
                <div class="stat-row">
                  <span class="stat-key">{{ stat }}</span>
                  <span class="stat-val {{ 'pos' if value > 0 else 'neg' if value < 0 else 'zero' }}">
                    {{ "%.6f"|format(value) }}
                  </span>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </section>

      <script type="application/json" id="box-data-json">
        {{ box_data | tojson }}
      </script>

      <script>
        const BOX_DATA_BY_POS = JSON.parse(
          document.getElementById("box-data-json").textContent
        );
        console.log("BOX_DATA_BY_POS keys:", Object.keys(BOX_DATA_BY_POS || {}));
      </script>

      <script>
      (function () {
        function toRows(dataObj) {
          const rows = [];
          for (const [feature, packed] of Object.entries(dataObj || {})) {
            if (!Array.isArray(packed) || packed.length !== 2) continue;
            const stats = packed[1];
            if (!Array.isArray(stats) || stats.length !== 5) continue;

            const [min, q1, mean, q3, max] = stats.map(Number);
            if ([min, q1, mean, q3, max].some(v => Number.isNaN(v))) continue;

            rows.push({ feature, min, q1, mean, q3, max });
          }
          return rows;
        }

        function computeDomain(rows) {
          let lo = Infinity, hi = -Infinity;
          for (const r of rows) {
            lo = Math.min(lo, r.min);
            hi = Math.max(hi, r.max);
          }
          if (!Number.isFinite(lo) || !Number.isFinite(hi) || lo === hi) { lo = -1; hi = 1; }
          const pad = (hi - lo) * 0.05;
          return { lo: lo - pad, hi: hi + pad };
        }

        function pct(v, dom) {
          return 100 * (v - dom.lo) / (dom.hi - dom.lo);
        }

        function renderPosition(pos) {
          const container = document.getElementById(`boxplot_container__${pos.replace(/ /g, "_")}`);
          if (!container) return;

          const showAllEl = document.querySelector(`.bp_show_all[data-pos="${pos}"]`);
          const showZeroEl = document.querySelector(`.bp_show_zero[data-pos="${pos}"]`);

          container.innerHTML = "";

          let rows = toRows(BOX_DATA_BY_POS[pos]);

          rows.sort((a, b) => b.mean - a.mean);

          // Only slice if show_all is off.
          const showAll = showAllEl && showAllEl.checked;
          const shown = showAll ? rows : rows.slice(0, 15);

          const dom = computeDomain(shown);
          const showZero = !showZeroEl || showZeroEl.checked;
          const zeroInRange = (dom.lo < 0 && dom.hi > 0);
          const zeroLeft = pct(0, dom);

          for (const r of shown) {
            const row = document.createElement("div");
            row.className = "bp-row";

            const label = document.createElement("div");
            label.className = "bp-label";
            label.textContent = r.feature;

            const plot = document.createElement("div");
            plot.className = "bp-plot";

            // Diverging colour by signed mean (same approach as team)
            const intensity = Math.min(1, Math.abs(r.mean) / (dom.hi - dom.lo) * 6);
            const alphaStrong = 0.20 + 0.55 * intensity;
            const alphaSoft   = 0.10 + 0.30 * intensity;

            if (r.mean >= 0) {
              plot.style.setProperty("--accent", `rgba(80, 200, 140, ${alphaStrong})`);
              plot.style.setProperty("--accent-soft", `rgba(80, 200, 140, ${alphaSoft})`);
            } else {
              plot.style.setProperty("--accent", `rgba(220, 90, 90, ${alphaStrong})`);
              plot.style.setProperty("--accent-soft", `rgba(220, 90, 90, ${alphaSoft})`);
            }

            if (showZero && zeroInRange) {
              const zero = document.createElement("div");
              zero.className = "bp-zero";
              zero.style.left = `${zeroLeft}%`;
              plot.appendChild(zero);
            }

            const whisker = document.createElement("div");
            whisker.className = "bp-whisker";
            const wLeft = pct(r.min, dom);
            const wRight = pct(r.max, dom);
            whisker.style.left = `${wLeft}%`;
            whisker.style.width = `${Math.max(0, wRight - wLeft)}%`;
            plot.appendChild(whisker);

            const capL = document.createElement("div");
            capL.className = "bp-cap";
            capL.style.left = `${wLeft}%`;
            plot.appendChild(capL);

            const capR = document.createElement("div");
            capR.className = "bp-cap";
            capR.style.left = `${wRight}%`;
            plot.appendChild(capR);

            const box = document.createElement("div");
            box.className = "bp-box";
            const bLeft = pct(r.q1, dom);
            const bRight = pct(r.q3, dom);
            box.style.left = `${bLeft}%`;
            box.style.width = `${Math.max(0, bRight - bLeft)}%`;
            plot.appendChild(box);

            const mean = document.createElement("div");
            mean.className = "bp-mean";
            mean.style.left = `${pct(r.mean, dom)}%`;
            plot.appendChild(mean);

            plot.title = `min ${r.min.toFixed(4)} | q1 ${r.q1.toFixed(4)} | mean ${r.mean.toFixed(4)} | q3 ${r.q3.toFixed(4)} | max ${r.max.toFixed(4)}`;

            row.appendChild(label);
            row.appendChild(plot);
            container.appendChild(row);
          }
        }

        function renderAll() {
          for (const pos of Object.keys(BOX_DATA_BY_POS)) {
            renderPosition(pos);
          }
        }

        // Bind toggles per position
        document.querySelectorAll(".bp_show_all").forEach(el => {
          el.addEventListener("change", () => renderPosition(el.dataset.pos));
        });
        document.querySelectorAll(".bp_show_zero").forEach(el => {
          el.addEventListener("change", () => renderPosition(el.dataset.pos));
        });

        renderAll();
      })();
      </script>
      {% endif %}
    </main>

  </div>
</body>
</html>
